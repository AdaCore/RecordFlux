name: tests

on:
  push:
  schedule:
    - cron:  '0 2 * * *'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

env:
    MEMCACHED: localhost:11211
    ALIRE_VERSION: "1.2.0"

jobs:
  skip_check_general:
    name: Skip Check General
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          paths_ignore: '["*.gpr", "examples/**", "tests/spark/**"]'

  checks:
    name: Checks
    needs: skip_check_general
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        target:
          - packages
          - dependencies
          - black
          - isort
          - flake8
          - pylint
          - mypy
          - pydocstyle
          - contracts
          - doc
    env:
      python-version: 3.8
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install dependencies
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        sudo apt install libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Check
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      run: |
        make check_${{ matrix.target }}

  installation:
    name: Installation
    needs: skip_check_general
    if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Cache GNAT Community
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel virtualenv
    - name: Install
      run: |
        make test_installation

  skip_check_python:
    name: Skip Check Python
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          paths: '[".github/workflows/**", "rflx/**", "tests/**"]'
          paths_ignore: '["tests/spark/**"]'

  tests_python:
    name: Tests
    needs: skip_check_python
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        target:
          - "python_coverage"
        python-version:
          - 3.8
          - 3.9
        include:
          - target: "python_unit"
            python-version: 3.8
          - target: "python_property"
            python-version: 3.8
          - target: "python_optimized"
            python-version: 3.8
    env:
      gnat-version: "23.0w-20220723"
      GNAT: "pro23.0w-20220723"
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python ${{ matrix.python-version }}
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ matrix.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ env.GNAT }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg', 'Makefile') }}
    - name: Install GNAT Pro
      uses: ./.github/actions/install_gnat_pro
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      with:
        version: ${{ env.gnat-version }}
        ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
        server: ${{ secrets.MEMCACHED_SERVER }}
    - name: Install SPARK Pro
      uses: ./.github/actions/install_spark_pro
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      with:
        version: "23.0w-20220612"
        ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
        server: ${{ secrets.MEMCACHED_SERVER }}
    - name: Install dependencies
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        echo "HYPOTHESIS_PROFILE=ci" >> $GITHUB_ENV
        sudo apt install graphviz libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Connect to Memcached server
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      shell: bash
      env:
        SSH_KEY: ${{ secrets.MEMCACHED_SSH_KEY }}
        SERVER: ${{ secrets.MEMCACHED_SERVER }}
      run: |
        eval $(ssh-agent -s)
        echo "$SSH_KEY" | tr -d '\r' | ssh-add - &>/dev/null
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan $SERVER >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        ssh -L 11211:localhost:11211 -N -T -f -o ExitOnForwardFailure=yes -o ServerAliveInterval=10 -o ServerAliveCountMax=3 ci@$SERVER &>/dev/null
        echo "stats" | nc -q 1 localhost 11211
    - name: Configure kernel parameters
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      run: |
        sudo /sbin/sysctl -w net.ipv4.ping_group_range="0 2147483647"
    - name: Test
      if: ${{ needs.skip_check_python.outputs.should_skip != 'true' }}
      run: |
        eval `make printenv_gnat`
        gnat --version
        make test_${{ matrix.target }}

  skip_check_compilation:
    name: Skip Check Compilation
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          paths: '[".github/workflows/**", "defaults.gpr", "examples/apps/**", "rflx/**", "tests/**"]'

  compilation:
    name: Compilation
    needs: skip_check_compilation
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        gnat-distrib:
          - "community"
        gnat-version:
          - "2020"
          - "2021"
        include:
          - gnat-distrib: "pro"
            gnat-version: "20.2"
          - gnat-distrib: "pro"
            gnat-version: "21.2"
          - gnat-distrib: "pro"
            gnat-version: "22.0"
          - gnat-distrib: "pro"
            gnat-version: "23.0w-20220723"
          - gnat-distrib: "fsf"
            gnat-version: "11.2.4"
          - gnat-distrib: "fsf"
            gnat-version: "12.1.2"
    env:
      python-version: 3.8
      GNAT: ${{ matrix.gnat-distrib }}${{ matrix.gnat-version }}
    steps:
      - uses: actions/checkout@v2
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' }}
        with:
          submodules: true
      - name: Set up Python ${{ env.python-version }}
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.python-version }}
      - name: Determine exact Python version
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' }}
        run:
          echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
      - name: Cache Python dependencies
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' }}
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python${{ env.python-version }}/site-packages
            ~/.local/bin
          key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ matrix.gnat-distrib }}${{ matrix.gnat-version }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg', 'Makefile') }}
      - name: Cache GNAT Community
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' && matrix.gnat-distrib == 'community' }}
        uses: actions/cache@v2
        with:
          path: /home/runner/work/gnat
          key: ${{ runner.os }}-gnat-ce${{ matrix.gnat-version }}
      - name: Install GNAT Community
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' && matrix.gnat-distrib == 'community' }}
        uses: ada-actions/toolchain@ce2021
        with:
          distrib: community
          community_year: ${{ matrix.gnat-version }}
          install_dir: /home/runner/work/gnat
      - name: Install GNAT Pro
        uses: ./.github/actions/install_gnat_pro
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' && matrix.gnat-distrib == 'pro' }}
        with:
          version: ${{ matrix.gnat-version }}
          ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
          server: ${{ secrets.MEMCACHED_SERVER }}
      - name: Cache Alire and FSF GNAT
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
        uses: actions/cache@v2
        with:
          path: |
            ~/.config/alire
            build/alire
          key: ${{ runner.os }}-alire${{ env.ALIRE_VERSION }}-python${{ env.PYTHON_VERSION }}-${{ matrix.gnat-distrib }}${{ matrix.gnat-version }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg', 'Makefile') }}
      - name: Install Alire
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
        uses: alire-project/setup-alire@v1
        with:
          version: ${{ env.ALIRE_VERSION }}
          toolchain: "--disable-assistant"
      - name: Install FSF GNAT
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
        env:
          FSF_GNAT_VERSION: ${{ matrix.gnat-version }}
        run: |
          make install_gnat
      # Note: RecordFlux-parser depends on the GNAT toolchain. If the caching of Python dependencies
      # is used, it must be ensured that the cached RecordFlux-parser fits to the selected GNAT
      # toolchain. In case of FSF GNAT, some libraries required by RecordFlux-parser
      # (e.g., libgnatcoll.so) must be cached as well, as they will be only created, if the
      # compilation during the installation of RecordFlux-parser is executed.
      - name: Install dependencies
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' }}
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
          echo "HYPOTHESIS_PROFILE=ci" >> $GITHUB_ENV
          sudo apt install graphviz libgmp-dev patchelf
          python -m pip install --upgrade pip wheel
          eval `make printenv_gnat`
          gnat --version
          make install_devel
      - name: Test
        if: ${{ needs.skip_check_compilation.outputs.should_skip != 'true' }}
        run: |
          eval `make printenv_gnat`
          gnat --version
          make test_compilation

  binary_size:
    name: Binary size
    runs-on: ubuntu-20.04
    env:
      python-version: 3.8
      gnat-version: "23.0w-20220723"
      GNAT: "pro23.0w-20220723"
    steps:
      - uses: actions/checkout@v2
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        with:
          submodules: true
      - name: Set up Python ${{ env.python-version }}
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.python-version }}
      - name: Determine exact Python version
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        run:
          echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
      - name: Cache Python dependencies
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python${{ env.python-version }}/site-packages
            ~/.local/bin
          key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-gnat${{ env.GNAT }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
      - name: Install GNAT Pro
        uses: ./.github/actions/install_gnat_pro
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        with:
          version: ${{ env.gnat-version }}
          ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
          server: ${{ secrets.MEMCACHED_SERVER }}
      - name: Install dependencies
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
          echo "HYPOTHESIS_PROFILE=ci" >> $GITHUB_ENV
          sudo apt install graphviz libgmp-dev patchelf
          python -m pip install --upgrade pip wheel
          make install_devel
      - name: Test
        if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
        run: |
          make test_binary_size

  verification_python_scheduled:
    name: Verification
    if: github.event.schedule
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        target: ["python_property_verification"]
        python-version: [3.8]
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Determine exact Python version
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ matrix.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install SPARK Pro
      uses: ./.github/actions/install_spark_pro
      with:
        version: "23.0w-20220612"
        ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
        server: ${{ secrets.MEMCACHED_SERVER }}
    - name: Install dependencies
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        echo "HYPOTHESIS_PROFILE=ci" >> $GITHUB_ENV
        sudo apt install graphviz libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Connect to Memcached server
      shell: bash
      env:
        SSH_KEY: ${{ secrets.MEMCACHED_SSH_KEY }}
        SERVER: ${{ secrets.MEMCACHED_SERVER }}
      run: |
        eval $(ssh-agent -s)
        echo "$SSH_KEY" | tr -d '\r' | ssh-add - &>/dev/null
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan $SERVER >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        ssh -L 11211:localhost:11211 -N -T -f -o ExitOnForwardFailure=yes -o ServerAliveInterval=10 -o ServerAliveCountMax=3 ci@$SERVER &>/dev/null
        echo "stats" | nc -q 1 localhost 11211
    - name: Test
      run: |
        make test_${{ matrix.target }}

  skip_check_spark:
    name: Skip Check SPARK
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          paths: '[".github/workflows/**", "*.gpr", "tests/spark/**"]'

  runtime_compatibility:
    name: Runtime compatibility
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        gnat-distrib:
          - "community"
          - "fsf"
    env:
      FSF_GNAT_VERSION: 11.2.4
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Cache GNAT Community
      if: ${{ matrix.gnat-distrib == 'community' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ matrix.gnat-distrib == 'community' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Cache Alire and FSF GNAT
      if: ${{ matrix.gnat-distrib == 'fsf' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.config/alire
          build/alire
        key: ${{ runner.os }}-alire${{ env.ALIRE_VERSION }}-fsf${{ env.FSF_GNAT_VERSION }}-${{ hashFiles('Makefile') }}
    - name: Install Alire
      if: ${{ matrix.gnat-distrib == 'fsf' }}
      uses: alire-project/setup-alire@v1
      with:
        version: ${{ env.ALIRE_VERSION }}
        toolchain: "--disable-assistant"
    - name: Install FSF GNAT
      if: ${{ matrix.gnat-distrib == 'fsf' }}
      run: |
        make install_gnat
    - name: Build
      run: |
        eval `make printenv_gnat`
        gnat --version
        make test_runtime

  verification_spark:
    name: Verification
    needs: skip_check_spark
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        test:
          - "builtin_types"
          - "custom_types"
          - "derivation"
          - "enumeration"
          - "ethernet"
          - "expression"
          - "fixed_size"
          - "in_ethernet"
          - "in_ipv4"
          - "in_tlv"
          - "ipv4"
          - "sequence"
          - "tlv"
    env:
      python-version: 3.8
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install SPARK Pro
      uses: ./.github/actions/install_spark_pro
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      with:
        version: "23.0w-20220612"
        ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
        server: ${{ secrets.MEMCACHED_SERVER }}
    - name: Install dependencies
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        sudo apt install libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Connect to Memcached server
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      shell: bash
      env:
        SSH_KEY: ${{ secrets.MEMCACHED_SSH_KEY }}
        SERVER: ${{ secrets.MEMCACHED_SERVER }}
      run: |
        eval $(ssh-agent -s)
        echo "$SSH_KEY" | tr -d '\r' | ssh-add - &>/dev/null
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan $SERVER >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        ssh -L 11211:localhost:11211 -N -T -f -o ExitOnForwardFailure=yes -o ServerAliveInterval=10 -o ServerAliveCountMax=3 ci@$SERVER &>/dev/null
        echo "stats" | nc -q 1 localhost 11211
    - name: Verify
      if: ${{ needs.skip_check_spark.outputs.should_skip != 'true' }}
      run: |
        make prove_tests TEST=${{ matrix.test }}

  skip_check_apps:
    name: Skip Check Apps
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          paths: '[".github/workflows/**", "defaults.gpr", "examples/apps/**", "rflx/**"]'

  tests_apps:
    name: App Tests
    needs: skip_check_apps
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - 3.8
          - 3.9
        gnat-distrib:
          - "community"
        gnat-version:
          - "2021"
        include:
          - python-version: 3.8
            gnat-distrib: "fsf"
            gnat-version: "11.2.4"
    env:
      GNAT: ${{ matrix.gnat-distrib }}${{ matrix.gnat-version }}
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python ${{ matrix.python-version }}
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ matrix.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install dependencies
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        echo "HYPOTHESIS_PROFILE=ci" >> $GITHUB_ENV
        sudo apt install graphviz libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Install Alire
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
      uses: alire-project/setup-alire@v1
      with:
        version: ${{ env.ALIRE_VERSION }}
        toolchain: "--disable-assistant"
    - name: Install FSF GNAT
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
      env:
        FSF_GNAT_VERSION: ${{ matrix.gnat-version }}
      run: |
        make install_gnat
    - name: Configure kernel parameters
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run: |
        sudo /sbin/sysctl -w net.ipv4.ping_group_range="0 2147483647"
    - name: Test
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run: |
        eval `make printenv_gnat`
        gnat --version
        make test_apps

  verification_apps:
    name: App Verification
    needs: skip_check_apps
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        app:
          - ping
          - dhcp_client
    env:
      python-version: 3.8
      # SPARK requires more than the available 7 GB of RAM for proving the DHCP client, if multiple
      # processes are used.
      GNATPROVE_PROCS: 1
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install SPARK Pro
      uses: ./.github/actions/install_spark_pro
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      with:
        version: "23.0w-20220612"
        ssh_key: ${{ secrets.MEMCACHED_SSH_KEY }}
        server: ${{ secrets.MEMCACHED_SERVER }}
    - name: Install dependencies
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        sudo apt install libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Connect to Memcached server
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      shell: bash
      env:
        SSH_KEY: ${{ secrets.MEMCACHED_SSH_KEY }}
        SERVER: ${{ secrets.MEMCACHED_SERVER }}
      run: |
        eval $(ssh-agent -s)
        echo "$SSH_KEY" | tr -d '\r' | ssh-add - &>/dev/null
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan $SERVER >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        ssh -L 11211:localhost:11211 -N -T -f -o ExitOnForwardFailure=yes -o ServerAliveInterval=10 -o ServerAliveCountMax=3 ci@$SERVER &>/dev/null
        echo "stats" | nc -q 1 localhost 11211
    - name: Verify
      if: ${{ needs.skip_check_apps.outputs.should_skip != 'true' }}
      run: |
        make -C examples/apps/${{ matrix.app }} prove

  skip_check_specs:
    name: Skip Check Specs
    continue-on-error: true
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v3.4.0
        with:
          paths: '[".github/workflows/**", "defaults.gpr", "examples/specs/**", "rflx/**"]'

  tests_specs:
    name: Specification Tests
    needs: skip_check_specs
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        gnat-distrib:
          - "community"
          - "fsf"
    env:
      python-version: 3.8
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python ${{ env.python-version }}
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install dependencies
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        echo "HYPOTHESIS_PROFILE=ci" >> $GITHUB_ENV
        sudo apt install graphviz libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Install Alire
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
      uses: alire-project/setup-alire@v1
      with:
        version: ${{ env.ALIRE_VERSION }}
        toolchain: "--disable-assistant"
    - name: Install FSF GNAT
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' && matrix.gnat-distrib == 'fsf' }}
      run: |
        make install_gnat
    - name: Test
      if: ${{ needs.skip_check_specs.outputs.should_skip != 'true' }}
      run: |
        eval `make printenv_gnat`
        gnat --version
        make test_specs

  documentation:
    name: Documentation
    needs: skip_check_general
    runs-on: ubuntu-20.04
    env:
      python-version: 3.8
    steps:
    - uses: actions/checkout@v2
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      with:
        submodules: true
    - name: Set up Python
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.python-version }}
    - name: Determine exact Python version
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      run:
        echo "PYTHON_VERSION=$(python -c 'import platform; print(platform.python_version())')" >> $GITHUB_ENV
    - name: Cache Python dependencies
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.python-version }}/site-packages
          ~/.local/bin
        key: ${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('setup.py', '.config/python-style/setup.cfg') }}
    - name: Cache GNAT Community
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: actions/cache@v2
      with:
        path: /home/runner/work/gnat
        key: ${{ runner.os }}-gnat-ce2021
    - name: Install GNAT Community
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      uses: ada-actions/toolchain@ce2021
      with:
        distrib: community
        install_dir: /home/runner/work/gnat
    - name: Install dependencies
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
        sudo apt install libgmp-dev patchelf
        python -m pip install --upgrade pip wheel
        make install_devel
    - name: Generate
      if: ${{ needs.skip_check_general.outputs.should_skip != 'true' }}
      run: |
        make doc
